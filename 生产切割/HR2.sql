
SELECT Z.DUTY_DATE,DATEPART(WK,Z.DUTY_DATE-1) AS WEEK,Z.人数,Z.总出勤时间,Z.直接出勤人数,Z.直接出勤时间
FROM 
(
SELECT Y.DUTY_DATE,COUNT(Y.A0190) AS '人数',SUM(出勤时间) AS '总出勤时间' ,
SUM(Y.直接出勤人数)AS 直接出勤人数,
SUM(Y.直接出勤时间) AS 直接出勤时间

FROM (
 SELECT x.*
FROM (
SELECT B.A0190, A.DUTY_DATE,SUM(A.K_ONHOURS+A.OVER_TIME)as '出勤时间' ,
COUNT(CASE WHEN (B.A01259=7 OR B.A01259=8 OR B.A01259 IS NULL) THEN (B.A0190) ELSE NULL END) AS 直接出勤人数,
SUM(CASE WHEN (B.A01259=7 OR B.A01259=8 OR B.A01259 IS NULL) THEN (A.K_ONHOURS+A.OVER_TIME) ELSE 0 END) AS 直接出勤时间
FROM K_DAY A
INNER JOIN A01 B ON A.A0188=B.A0188
--INNER JOIN B01 C ON B.DEPT_CODE=C.DEPT_CODE
WHERE DUTY_DATE>=CASE WHEN DAY(GETDATE())=1 THEN DATEADD(MONTH,DATEDIFF(MONTH,0,GETDATE())-1,0) ELSE DATEADD(MONTH,DATEDIFF(MONTH,0,GETDATE()),0) END
AND DUTY_DATE< DATEADD(DAY, 0, DATEDIFF(DAY, 0, GETDATE())) 
AND B.DEPT_CODE IN 
('10232020000'
,'10232020002'
,'10232020004'
,'102320202'
,'102320204'
,'1023202060000'
,'1023202060002'
,'1023202060004'
,'1023202060006'
,'1023202060007'
,'1023202060200'
,'1023202060202'
,'1023202060204'
,'1023202060400'
,'1023202060402'
,'1023202060404'
,'1023202060600'
,'1023202060602'
,'1023202060604'
,'1023202060800'
,'1023202060802'
,'1023202060803'
,'1023202060804'
,'1023202060805'
,'102320208')
GROUP BY B.A0190, A.DUTY_DATE
)X
WHERE X.[出勤时间]<>0
)Y
GROUP BY Y.DUTY_DATE
)Z
ORDER BY Z.DUTY_DATE